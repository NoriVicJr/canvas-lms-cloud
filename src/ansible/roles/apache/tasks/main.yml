---

- name: install apache related packages
  apt: pkg={{ item }} state=latest update_cache=yes cache_valid_time=3600
  with_items:
     - apache2
     - libapache2-mod-passenger
  when: not (hostvars[inventory_hostname]['delayed_jobs']|default(false))|bool
  tags:
    - apache
    - install

- name: enable apache passenger mod
  command: a2enmod passenger creates=/etc/apache2/mods-enabled/passenger.load
  when: not (hostvars[inventory_hostname]['delayed_jobs']|default(false))|bool
  notify: restart apache service
  tags:
    - apache
    - configure

- name: remove default apache sites
  file: path={{ item }} state=absent
  with_items:
    - /etc/apache2/sites-enabled/000-default.conf
    - /etc/apache2/sites-available/000-default.conf
    - /etc/apache2/sites-available/default-ssl.conf
  when: not (hostvars[inventory_hostname]['delayed_jobs']|default(false))|bool
  notify: restart apache service
  tags:
    - apache
    - configure

- name: configure canvas apache site
  template: src=etc/apache2/sites-available/canvas.j2 dest=/etc/apache2/sites-available/canvas
  when: not (hostvars[inventory_hostname]['delayed_jobs']|default(false))|bool
  notify: restart apache service
  tags:
    - apache
    - configure

- name: enable canvas apache site
  command: a2ensite canvas
  when: not (hostvars[inventory_hostname]['delayed_jobs']|default(false))|bool
  notify: restart apache service
  tags:
    - apache
    - configure
